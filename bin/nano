#!/usr/bin/env php
<?php

declare(strict_types=1);

namespace Bin;

use Hyperf\Contract\StdoutLoggerInterface;
use Hyperf\Framework\Event\BootApplication;
use Hyperf\HttpMessage\Stream\SwooleStream;
use Nano\ContainerProxy;
use Nano\Factory\AppFactory;

require_once __DIR__ . '/../vendor/autoload.php';

$app = AppFactory::createBase();

$app->get('/', function () {
    /** @var ContainerProxy $this */
    return $this->response->json(['nano']);
});

$app->post('/', function () {
    /** @var ContainerProxy $this */
    return $this->response->json(['json']);
});

$app->addMiddleware(function ($request, $handler) {
    $request = $request->withAttribute('key', 'value');
    return $handler->handle($request);
});

$app->addExceptionHandler(function ($throwable, $response) {var_dump($throwable->getMessage());
    return $response->withStatus('418')->withBody(new SwooleStream('I\'m a teapot'));
});

$app->addListener(BootApplication::class, function ($event) {
    $this->get(StdoutLoggerInterface::class)->info('App started');
});

$app->run();
